"use strict";var GameState,__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(s,o){function r(t){try{h(n.next(t))}catch(e){o(e)}}function a(t){try{h(n.throw(t))}catch(e){o(e)}}function h(t){var e;t.done?s(t.value):((e=t.value)instanceof i?e:new i(function(t){t(e)})).then(r,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){var i,n,s,o,r={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function o(a){if(i)throw TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(s=2&a[0]?n.return:a[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,a[1])).done)return s;switch(n=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,n=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(s=(s=r.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){r=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(6===a[0]&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(h){a=[6,h],n=0}finally{i=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([o,a])}}},__read=this&&this.__read||function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,s,o=i.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)r.push(n.value)}catch(a){s={error:a}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(s)throw s.error}}return r},__spread=this&&this.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t};!function(t){t[t.SplashScreen=0]="SplashScreen",t[t.Playing=1]="Playing",t[t.PlayerDying=2]="PlayerDying",t[t.ScoreScreen=3]="ScoreScreen"}(GameState||(GameState={}));var sounds={jump:new Howl({src:["assets/sounds/sfx_wing.ogg"],volume:.3}),score:new Howl({src:["assets/sounds/sfx_point.ogg"],volume:.3}),hit:new Howl({src:["assets/sounds/sfx_hit.ogg"],volume:.3}),die:new Howl({src:["assets/sounds/sfx_die.ogg"],volume:.3}),swoosh:new Howl({src:["assets/sounds/sfx_swooshing.ogg"],volume:.3})},wait=function(t){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e){setTimeout(e,t)})]})})},log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];console.log.apply(console,__spread(["["+Date.now()+"]"],t))},toRad=function(t){return t*Math.PI/180},isBoxIntersecting=function(t,e){return t.x<=e.x+e.width&&e.x<=t.x+t.width&&t.y<=e.y+e.height&&e.y<=t.y+t.height},debugBoxes=new Map,debuggerEnabled=!1,drawDebugBox=function(t,e){if(debuggerEnabled){if(!debugBoxes.has(t)){var i=document.createElement("div");i.className="boundingbox",document.getElementById("debug").appendChild(i),debugBoxes.set(t,i)}var n=debugBoxes.get(t);if(null==n){log("couldn't create a debug box for "+t);return}n.style.top=e.y+"px",n.style.left=e.x+"px",n.style.width=e.width+"px",n.style.height=e.height+"px"}},Game=function(){function t(t){this.domElements=t,this.bird=new Bird(t.bird,{gravity:.25,jumpVelocity:-4.6,flightAreaBox:t.flightArea.getBoundingClientRect()}),this.pipes=new PipeManager(t.flightArea),this.land=new Land(t.land),this.state=GameState.SplashScreen}return t.prototype.onKeyboardEvent=function(t){32===t.keyCode&&(this.state===GameState.Playing?this.bird.jump():this.state===GameState.SplashScreen?this.start():(this.state,GameState.ScoreScreen))},t.prototype.onScreenTouch=function(){this.state===GameState.SplashScreen?this.start():this.state===GameState.Playing&&this.bird.jump()},t.prototype.start=function(){this.state=GameState.Playing,this.gameLoop=setInterval(this.tick.bind(this),1e3/60),requestAnimationFrame(this.draw.bind(this))},t.prototype.die=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.state=GameState.PlayerDying,clearInterval(this.gameLoop),Array.from(document.getElementsByClassName("animated")).forEach(function(t){t.style.animationPlayState="paused",t.style.webkitAnimationPlayState="paused"}),[4,this.bird.die()];case 1:return t.sent(),this.state=GameState.ScoreScreen,[4,wait(500)];case 2:return t.sent(),sounds.swoosh.play(),[2]}})})},t.prototype.tick=function(){var t=Date.now();this.bird.tick(),this.pipes.tick(t),(this.pipes.intersectsWith(this.bird.box)||this.land.intersectsWith(this.bird.box))&&this.die()},t.prototype.draw=function(){requestAnimationFrame(this.draw.bind(this)),this.bird.draw()},t}(),Bird=function(){function t(t,e){this.width=34,this.height=24,this.velocity=0,this.position=180,this.rotation=0,this.box={x:60,y:180,width:34,height:24},this.domElement=t,this.flyingProperties=e}return t.prototype.tick=function(){this.velocity+=this.flyingProperties.gravity,this.rotation=Math.min(this.velocity/10*90,90),this.position+=this.velocity,this.position<0&&(this.position=0),this.position>this.flyingProperties.flightAreaBox.height&&(this.position=this.flyingProperties.flightAreaBox.height);var t=Math.abs(toRad(this.rotation)),e=this.height-this.width,i=this.width-this.height;this.box.width=this.width+e*Math.sin(t),this.box.height=this.height+i*Math.sin(t);var n=(this.width-this.box.width)/2,s=(this.height-this.box.height)/2;this.box.x=60+n,this.box.y=this.position+s+this.flyingProperties.flightAreaBox.y},t.prototype.jump=function(){this.velocity=this.flyingProperties.jumpVelocity,sounds.jump.play()},t.prototype.die=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.domElement.style.transition="\n            transform 1s cubic-bezier(0.65, 0, 0.35, 1)\n        ",this.position=this.flyingProperties.flightAreaBox.height-this.height,this.rotation=90,sounds.hit.play(),[4,wait(500)];case 1:return t.sent(),sounds.die.play(),[4,wait(500)];case 2:return t.sent(),this.domElement.style.transition="",[2]}})})},t.prototype.draw=function(){drawDebugBox(this.domElement,this.box),this.domElement.style.transform="\n            translate3d(0px, "+this.position+"px, 0px)\n            rotate3d(0, 0, 1, "+this.rotation+"deg)\n        "},t}(),Land=function(){function t(t){this.domElement=t,this.box=t.getBoundingClientRect(),drawDebugBox(this.domElement,this.box)}return t.prototype.intersectsWith=function(t){return isBoxIntersecting(this.box,t)},t}(),Pipe=function(){function t(){this.upperBox={x:0,y:0,width:0,height:0},this.lowerBox={x:0,y:0,width:0,height:0},this.domElement=document.createElement("div"),this.domElement.className="pipe animated",this.upperPipeDomElement=document.createElement("div"),this.upperPipeDomElement.className="pipe_upper",this.upperPipeDomElement.style.height="165px",this.lowerPipeDomElement=document.createElement("div"),this.lowerPipeDomElement.className="pipe_lower",this.lowerPipeDomElement.style.height="165px",this.domElement.appendChild(this.upperPipeDomElement),this.domElement.appendChild(this.lowerPipeDomElement)}return t.prototype.isOffScreen=function(){return this.upperBox.x<=-100},t.prototype.tick=function(){this.upperBox=this.upperPipeDomElement.getBoundingClientRect(),this.lowerBox=this.lowerPipeDomElement.getBoundingClientRect(),drawDebugBox(this.upperPipeDomElement,this.upperBox),drawDebugBox(this.lowerPipeDomElement,this.lowerBox)},t.prototype.intersectsWith=function(t){return isBoxIntersecting(this.upperBox,t)||isBoxIntersecting(this.lowerBox,t)},t}(),PipeManager=function(){function t(t){this.pipeDelay=1400,this.lastPipeInsertedTimestamp=0,this.pipes=[],this.pipeAreaDomElement=t}return t.prototype.tick=function(t){if(this.pipes.forEach(function(t){return t.tick()}),!(t-this.lastPipeInsertedTimestamp<this.pipeDelay)){log("inserting pipe after",t-this.lastPipeInsertedTimestamp,"ms"),this.lastPipeInsertedTimestamp=t;var e=new Pipe;this.pipes.push(e),this.pipeAreaDomElement.appendChild(e.domElement),this.pipes=this.pipes.filter(function(t){return!t.isOffScreen()||(log("pruning a pipe"),t.domElement.remove(),!1)})}},t.prototype.intersectsWith=function(t){return null!=this.pipes.find(function(e){return e.intersectsWith(t)})},t}();!function(){var t=document.getElementById("player"),e=document.getElementById("land"),i=document.getElementById("flyarea");if(null==t||null==i||null==e)throw Error("Missing an element");var n=new Game({bird:t,land:e,flightArea:i});document.onkeydown=n.onKeyboardEvent.bind(n),"ontouchstart"in document?document.ontouchstart=n.onScreenTouch.bind(n):document.onmousedown=n.onScreenTouch.bind(n),n.start()}();